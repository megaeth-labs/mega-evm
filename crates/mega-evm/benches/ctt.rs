//! Benchmarks for the `ConcurrencyTortureTest` batchTransfer operation.
//!
//! This benchmark suite measures the performance of the `batchTransfer` function
//! from the `ConcurrencyTortureTest` (CTT) contract, comparing performance across
//! different EVM specifications (`EQUIVALENCE` vs `MINI_REX`).

#![allow(missing_docs)]

use alloy_primitives::{address, bytes, Address, Bytes, U256};
use criterion::{black_box, criterion_group, criterion_main, Criterion};
use mega_evm::{
    test_utils::MemoryDatabase, DefaultExternalEnvs, MegaContext, MegaEvm, MegaSpecId,
    MegaTransaction,
};
use revm::{context::tx::TxEnvBuilder, primitives::KECCAK_EMPTY, ExecuteCommitEvm, ExecuteEvm};

const DEPLOYER: Address = address!("0000000000000000000000000000000000100000");
const CALLER: Address = address!("0000000000000000000000000000000000100001");

/// CTT deployment bytecode. Compiled at commit 0bcd874ab95f1300d1796888cd2ce087e1773b55 of
/// git@github.com:megaeth-labs/concurrency-torture-test.git
const CTT_DEPLOY_CODE: Bytes = bytes!("0x6101406040523461033557604051601f611f4b38819003918201601f19168301916001600160401b038311848410176102165780849260809460405283398101031261033557805190602081015191606060408301519201516001831180610328575b156102ce5760648211610275578260805260a05260c052801561026157808083049206820180831161024d57610096610339565b9081525f808052602052517fad3228b676f7d3cd4284a5443f17f1962b36e491b30a40b2405849e597ba5fb55560015b81811061022a5760405161077d8082016001600160401b03811183821017610216578291611365833903905ff0801561020b576001600160a01b031660e0526040516101008082016001600160401b03811183821017610216578291611ae2833903905ff0801561020b576001600160a01b0316610100526040516103698082016001600160401b03811183821017610216578291611be2833903905ff0801561020b576001600160a01b03166101205260405161100c908161035982396080518181816102f90152818161081e015281816108d60152610bb1015260a051818181610369015281816108fc01528181610e3f0152610ebf015260c0518181816102bf0152818161089c0152610b88015260e05181818161016c01526109340152610100518181816103a10152610570015261012051818181610279015261069f0152f35b6040513d5f823e3d90fd5b634e487b7160e01b5f52604160045260245ffd5b600190610235610339565b848152815f525f60205260405f2090519055016100c6565b634e487b7160e01b5f52601160045260245ffd5b634e487b7160e01b5f52601260045260245ffd5b60405162461bcd60e51b815260206004820152602b60248201527f4354543a20626c6f636b496e666f5265616450657263656e74616765206d757360448201526a074206265203c3d203130360ac1b6064820152608490fd5b60405162461bcd60e51b815260206004820152602c60248201527f4354543a2063656c6c436f756e74206d757374206265206265747765656e203260448201526b020616e64203130302c3030360a41b6064820152608490fd5b50620186a0831115610062565b5f80fd5b60405190602082016001600160401b038111838210176102165760405256fe60806040526004361015610011575f80fd5b5f3560e01c806305d48b21146101145780630d3eadda1461010f5780631941fd141461010a5780635a5173b314610105578063660844f01461010057806374eee84c146100fb5780637b49b4ae146100f657806382106275146100f157806396e17e4d146100ec5780639f366f67146100e7578063a8ae91cd146100e2578063b1444901146100dd578063c77e41dd146100d8578063dd70c8ec146100d3578063fd433182146100ce5763fd65f099146100c9575f80fd5b610429565b61040c565b6103f2565b6103d0565b61038c565b610352565b61031c565b6102e2565b6102a8565b610264565b61021f565b6101e0565b6101c4565b61019b565b610157565b61013b565b60809060031901126101375760043590602435906044359060643590565b5f80fd5b346101375761015561014c36610119565b9291909161051e565b005b34610137575f366003190112610137576040517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b34610137576020366003190112610137576004355f525f602052602060405f2054604051908152f35b34610137575f3660031901126101375760206040516127108152f35b346101375760206101fc6101f336610119565b929190916105d6565b6040516001600160a01b039091168152f35b6001600160a01b0381160361013757565b346101375760203660031901126101375760043561023c8161020e565b60018060a01b03165f526001602052602067ffffffffffffffff60405f205416604051908152f35b34610137575f366003190112610137576040517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b34610137575f3660031901126101375760206040517f00000000000000000000000000000000000000000000000000000000000000008152f35b34610137575f3660031901126101375760206040517f00000000000000000000000000000000000000000000000000000000000000008152f35b346101375760a0366003190112610137576004356004811015610137576101fc602091602435604435606435916084359361072f565b34610137575f3660031901126101375760206040517f00000000000000000000000000000000000000000000000000000000000000008152f35b34610137575f366003190112610137576040517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b34610137575f3660031901126101375760206103ea610812565b604051908152f35b346101375761015561040336610119565b92919091610870565b34610137575f366003190112610137576020600254604051908152f35b346101375761015561043a36610119565b92919091610ad9565b1561044a57565b60405162461bcd60e51b815260206004820152602c60248201527f4354543a206e756d53656e6465727320616e64206e756d52656365697665727360448201526b0206d757374206265203e20360a41b6064820152608490fd5b634e487b7160e01b5f52604160045260245ffd5b90601f8019910116810190811067ffffffffffffffff8211176104da57604052565b6104a4565b3d15610519573d9067ffffffffffffffff82116104da576040519161050e601f8201601f1916602001846104b8565b82523d5f602084013e565b606090565b905f938493831515806105aa575b61053590610443565b604051926020840194630d02bd9760e31b865260248501526044840152606483015260848201526084815261056b60a4826104b8565b5190827f00000000000000000000000000000000000000000000000000000000000000005af16105996104df565b90156105a25750565b602081519101fd5b5082151561052c565b9081602091031261013757516105c88161020e565b90565b6040513d5f823e3d90fd5b90929161069a60209383151580610708575b6105f190610443565b325f908152600160205260409020610653908290610618905b5467ffffffffffffffff1690565b6040519061064e826106408b8201600d906c10d4915055114c97d0d2125311609a1b81520190565b03601f1981018452836104b8565b610eaa565b60405163318600cf60e01b8152600481019190915230602482015260448101949094526064840195909552608483019190915260a4820193909352918290819060c4820190565b03815f7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03165af1908115610703575f916106da575090565b6105c8915060203d6020116106fc575b6106f481836104b8565b8101906105b3565b503d6106ea565b6105cb565b508515156105e8565b6004111561071b57565b634e487b7160e01b5f52602160045260245ffd5b939291909361073d81610711565b80610750575061074c93610ad9565b5f90565b61075981610711565b6001810361076b575061074c93610870565b61077481610711565b60028103610786575061074c9361051e565b80610792600392610711565b036107a0576105c8936105d6565b60405162461bcd60e51b81526020600482015260166024820152754354543a20496e76616c69642063616c6c207479706560501b6044820152606490fd5b634e487b7160e01b5f52601160045260245ffd5b600101908160011161080057565b6107de565b9190820180921161080057565b5f9060025461086a575f7f00000000000000000000000000000000000000000000000000000000000000005b808210610849575050565b9092835f525f60205260405f2054810180911161080057926001019061083e565b5f199150565b905f9384938315158061095d575b61088790610443565b6040519260208401946317f613d160e31b86527f0000000000000000000000000000000000000000000000000000000000000000602486015260448501526064840152608483015260a48201527f000000000000000000000000000000000000000000000000000000000000000060c48201527f000000000000000000000000000000000000000000000000000000000000000060e482015260e48152610930610104826104b8565b51907f00000000000000000000000000000000000000000000000000000000000000005af46105996104df565b5082151561087e565b1561096d57565b60405162461bcd60e51b815260206004820152602660248201527f4354543a20726561644f6e6c7950657263656e74616765206d7573742062652060448201526503c3d203130360d41b6064820152608490fd5b67ffffffffffffffff60019116019067ffffffffffffffff821161080057565b81156109eb570690565b634e487b7160e01b5f52601260045260245ffd5b15610a0657565b60405162461bcd60e51b815260206004820152602860248201527f4354543a20696e73756666696369656e742062616c616e636520696e2073656e60448201526719195c8818d95b1b60c21b6064820152608490fd5b15610a6357565b60405162461bcd60e51b815260206004820152602d60248201527f4354543a207472616e7366657220776f756c64206f766572666c6f772072656360448201526c65697665722062616c616e636560981b6064820152608490fd5b9190820391821161080057565b5f1981146108005760010190565b9081151580610e20575b610aec90610443565b610af96064841115610966565b325f908152600160205260409020610b1990610b149061060a565b6109c1565b325f908152600160205260409020805467ffffffffffffffff191667ffffffffffffffff83161790555f935f95610b82604051610b7c81610b6e60208201600a9069424c4f434b5f494e464f60b01b81520190565b03601f1981018352826104b8565b84610e29565b606481067f000000000000000000000000000000000000000000000000000000000000000011610df7575b505f7f00000000000000000000000000000000000000000000000000000000000000009083151593612711915b888110610c0f57505050505050505050610bf390610f63565b03610bfa57565b610c0d610c08600254610acb565b600255565b565b868b8487610c3e88610c3983604051610c3381610b6e8c6020830160209181520190565b88610eaa565b6109e1565b92868b610c52865f525f60205260405f2090565b54968791610dac575b505050610c869291610b6e610c80610c39936040519283916020830160209181520190565b8d610eaa565b5f5b8b8110610c9d57505050506001905b01610bda565b808b610cd18a610c398d600196610ccb8c610b6e604051938492602084019091604092825260208201520190565b85610eaa565b808614610da55780610d4186610d3b81610d137f77a84327eb5534e95fa55d5a8a7ccc7e19c6cee0e9777fd78e8dda84b2275fac965f525f60205260405f2090565b549b610d21828210156109ff565b610d368d610d2f8482610805565b1015610a5c565b610abe565b99610805565b9088610d54895f525f60205260405f2090565b5581610d67825f525f60205260405f2090565b556040805167ffffffffffffffff95909516855260208501889052840188905260608401899052608084015260a0830152329160c090a25b01610c88565b5050610d9f565b84610ddd92610dd69261064e8c610640604051948592602084019091604092825260208201520190565b6064900690565b10610dea5786858d610c5b565b5050505050600190610c97565b610e0a919750610e0f9296506009900690565b6107f2565b93610e1985610f63565b955f610bad565b50801515610ae3565b6020610e9f605c600194604051938491818301967f000000000000000000000000000000000000000000000000000000000000000088523260601b604085015267ffffffffffffffff60c01b9060c01b1660548401528051918291018484015e81015f838201520301601f1981018352826104b8565b519020906105c85790565b90610f1f605c602092604051938491818301967f000000000000000000000000000000000000000000000000000000000000000088523260601b604085015267ffffffffffffffff60c01b9060c01b1660548401528051918291018484015e81015f838201520301601f1981018352826104b8565b519020905f905b808210610f3257505090565b9091600190604051610f5881610b6e876020830195869091604092825260208201520190565b519020920190610f26565b60018103610f7057504890565b60028103610f7d57504a90565b60038103610f8a57504690565b60048103610f9757504190565b60058103610fa457504490565b60068103610fb157504590565b60078103610fbe57504390565b60088103610fcb57504490565b60090361074c57429056fea26469706673582212205cf443ae3ff796f483da8f3136046f6f42b4741de464846b1af03f977336b13864736f6c634300081e003360808060405234601557610763908161001a8239f35b5f80fdfe60806040526004361015610011575f80fd5b5f3560e01c63bfb09e8814610024575f80fd5b346103385760e03660031901126103385760043560843560243560443560a43560643560c4358415158061032f575b61005c9061033c565b6100686001841161039d565b61007560648311156103e9565b610087325f52600160205260405f2090565b926100a261009d855467ffffffffffffffff1690565b610458565b8094555f965f986100e66040516100df816100d160208201600a9069424c4f434b5f494e464f60b01b81520190565b03601f19810183528261047d565b87866105b8565b906064820610610306575b506127115f5b88811061011a578a6101088b6106b6565b0361010f57005b600280546001019055005b610197858c84868b6101508a61014b846100d16101448c6040519283916020830160209181520190565b858a61061d565b6104b3565b938c6101a361019c858b8661016c8b5f525f60205260405f2090565b805460408051602081019590955284018190529d909c9083606081015b03601f19810185528461047d565b61061d565b6064900690565b106102f757916101cb61014b926101d96101df96956040519384916020830160209181520190565b03601f19810184528361047d565b8d61061d565b8b8b89898c5f945b8510610200575050505050505050506001905b016100f7565b61022c9291858561014b936101978e610189604051958692602084019091604092825260208201520190565b8085146102ed57907f77a84327eb5534e95fa55d5a8a7ccc7e19c6cee0e9777fd78e8dda84b2275fac61029897836102a38761029d8161027660019a995f525f60205260405f2090565b9586549e8f610287848410156104ec565b61029184826104df565b1015610549565b6105ab565b9b6104df565b8a8a55918290556040805167ffffffffffffffff959095168552602085018890528401889052606084018a9052608084015260a0830152329160c090a25b018b89898f8d906101e7565b50506001906102e1565b505050505050506001906101fa565b61031991995061031e9298506009900690565b6104d1565b95610328876106b6565b975f6100f1565b50831515610053565b5f80fd5b1561034357565b60405162461bcd60e51b815260206004820152602c60248201527f4354543a206e756d53656e6465727320616e64206e756d52656365697665727360448201526b0206d757374206265203e20360a41b6064820152608490fd5b156103a457565b60405162461bcd60e51b815260206004820152601960248201527f4354543a206e756d43656c6c73206d757374206265203e2031000000000000006044820152606490fd5b156103f057565b60405162461bcd60e51b815260206004820152602660248201527f4354543a20726561644f6e6c7950657263656e74616765206d7573742062652060448201526503c3d203130360d41b6064820152608490fd5b634e487b7160e01b5f52601160045260245ffd5b67ffffffffffffffff60019116019067ffffffffffffffff821161047857565b610444565b90601f8019910116810190811067ffffffffffffffff82111761049f57604052565b634e487b7160e01b5f52604160045260245ffd5b81156104bd570690565b634e487b7160e01b5f52601260045260245ffd5b600101908160011161047857565b9190820180921161047857565b156104f357565b60405162461bcd60e51b815260206004820152602860248201527f4354543a20696e73756666696369656e742062616c616e636520696e2073656e60448201526719195c8818d95b1b60c21b6064820152608490fd5b1561055057565b60405162461bcd60e51b815260206004820152602d60248201527f4354543a207472616e7366657220776f756c64206f766572666c6f772072656360448201526c65697665722062616c616e636560981b6064820152608490fd5b9190820391821161047857565b909161060f605c60019460206040519485928284019788523260601b604085015267ffffffffffffffff60c01b9060c01b1660548401528051918291018484015e81015f838201520301601f19810183528261047d565b5190209061061a5790565b90565b9190605c6106729160206040519485928284019788523260601b604085015267ffffffffffffffff60c01b9060c01b1660548401528051918291018484015e81015f838201520301601f19810183528261047d565b519020905f905b80821061068557505090565b90916001906040516106ab816100d1876020830195869091604092825260208201520190565b519020920190610679565b600181036106c357504890565b600281036106d057504a90565b600381036106dd57504690565b600481036106ea57504190565b600581036106f757504490565b6006810361070457504590565b6007810361071157504390565b6008810361071e57504490565b600903610729574290565b5f9056fea2646970667358221220a4bcc3777bb41dc90dbc866c57aa4c6ea571d71031195916664ccb5fd8163e4764736f6c634300081e00336080806040523460145760e790816100198239f35b5f80fdfe60808060405260043610156011575f80fd5b5f905f3560e01c636815ecb8146025575f80fd5b3460ad57608036600319011260ad57333b1560ad5763fd65f09960e01b815260043560048201526024356024820152604435604482015260643560648201525f8160848183335af1801560a2576079575080f35b905067ffffffffffffffff8111608e57604052005b634e487b7160e01b5f52604160045260245ffd5b6040513d5f823e3d90fd5b5f80fdfea2646970667358221220f175208873a77bf072379c6ff131eeaae1326bd45c2f48995824ed2c602ed5a664736f6c634300081e00336080806040523460155761034f908161001a8239f35b5f80fdfe60806040526004361015610011575f80fd5b5f3560e01c63318600cf14610024575f80fd5b346100895760c0366003190112610089576024356001600160a01b03811681036100895761006b6100859161005860443590565b6064356084359160a43593600435610121565b6040516001600160a01b0390911681529081906020820190565b0390f35b5f80fd5b90601f8019910116810190811067ffffffffffffffff8211176100af57604052565b634e487b7160e01b5f52604160045260245ffd5b805191908290602001825e015f815290565b156100dc57565b60405162461bcd60e51b815260206004820152601e60248201527f4354543a2043524541544532206465706c6f796d656e74206661696c656400006044820152606490fd5b946101a79294610199946101229660405197610140602082018a61008d565b8089526101f860208a01396040519460018060a01b0316602086015260408501526060840152608083015260a082015260a0815261017f60c08261008d565b6040519283916101936020840180976100c3565b906100c3565b03601f19810183528261008d565b51905ff5906101c06001600160a01b03831615156100d5565b6040516001600160a01b03831681527f916f35ba24f3be9802a8b5ffca961b5cd764d08fcfd24c270bc1c58b948e886290602090a156fe60808060405260a08161012280380380916018828560b2565b83398101031260ae5780516001600160a01b0381169081900360ae576020820151906040830151906080606085015194015192813b1560ae575f6084928195604051978896879563fd65f09960e01b875260048701526024860152604485015260648401525af1801560a3576096575b604051603990816100e98239f35b5f609e9160b2565b5f6088565b6040513d5f823e3d90fd5b5f80fd5b601f909101601f19168101906001600160401b0382119082101760d457604052565b634e487b7160e01b5f52604160045260245ffdfe5f80fdfea2646970667358221220c1b785695bcc466bc621dad0960a0d161ccc9db357b5516454f683de2fc4397264736f6c634300081e0033a26469706673582212200de4490c305b2997f987b3670cef90af77fd7a480fffe15b04ab7ea8bda349b964736f6c634300081e0033");
const TOTAL_SUPPLY: u64 = 1_000_000_000;
const CELL_COUNT: u64 = 100;
const BLOCK_INFO_READ_PERCENTAGE: u64 = 20;
const SEED: [u8; 32] = *b"test-seed-for-ctt-benchmarking!!";

/// Deploy CTT contract and return the deployed address and post-deployment database
fn deploy_ctt(spec: MegaSpecId) -> (Address, MemoryDatabase) {
    let creation_code = CTT_DEPLOY_CODE;

    // Encode constructor parameters: (blockInfoReadPercentage, totalSupply, cellCount, seed)
    let mut constructor_args = Vec::new();
    constructor_args.extend_from_slice(&U256::from(BLOCK_INFO_READ_PERCENTAGE).to_be_bytes::<32>());
    constructor_args.extend_from_slice(&U256::from(TOTAL_SUPPLY).to_be_bytes::<32>());
    constructor_args.extend_from_slice(&U256::from(CELL_COUNT).to_be_bytes::<32>());
    constructor_args.extend_from_slice(&SEED);

    let mut deploy_data = creation_code.to_vec();
    deploy_data.extend_from_slice(&constructor_args);

    // Set up database with deployer and caller balances
    let mut db = MemoryDatabase::default()
        .account_balance(DEPLOYER, U256::from(10).pow(U256::from(18)))
        .account_balance(CALLER, U256::from(10).pow(U256::from(18)));

    let mut context = MegaContext::new(&mut db, spec, DefaultExternalEnvs::default());
    context.modify_chain(|chain| {
        chain.operator_fee_scalar = Some(U256::from(0));
        chain.operator_fee_constant = Some(U256::from(0));
    });
    let mut evm = MegaEvm::new(context);

    // Deploy contract (CREATE transaction with no 'to' address)
    let tx = TxEnvBuilder::new()
        .gas_limit(1_000_000_000)
        .caller(DEPLOYER)
        .create()
        .data(Bytes::from(deploy_data))
        .build_fill();
    let mut mega_tx = MegaTransaction::new(tx);
    mega_tx.enveloped_tx = Some(Bytes::new());

    let result = evm.transact_commit(mega_tx).expect("deployment should succeed");
    assert!(result.is_success(), "CTT deployment failed");

    // Calculate the deployed contract address: keccak256(rlp([sender, nonce]))[12:]
    // For the first transaction from DEPLOYER, nonce is 0
    let deployed_address = DEPLOYER.create(0);

    // check if the deployment is successful
    let deployed_info = &db.load_account(deployed_address).unwrap().info;
    deployed_info.code.as_ref().expect("code should be present");
    assert_ne!(deployed_info.code_hash, KECCAK_EMPTY);

    (deployed_address, db)
}

/// Encode a call to batchTransfer(uint256,uint256,uint256,uint256)
/// Function selector: 0xfd65f099
fn encode_batch_transfer_call(
    num_senders: u64,
    num_receivers: u64,
    read_only_percentage: u64,
    complexity: u64,
) -> Bytes {
    let mut calldata = Vec::with_capacity(4 + 32 * 4);

    // Function selector: batchTransfer(uint256,uint256,uint256,uint256)
    calldata.extend_from_slice(&[0xfd, 0x65, 0xf0, 0x99]);

    // Encode parameters (all uint256)
    calldata.extend_from_slice(&U256::from(num_senders).to_be_bytes::<32>());
    calldata.extend_from_slice(&U256::from(num_receivers).to_be_bytes::<32>());
    calldata.extend_from_slice(&U256::from(read_only_percentage).to_be_bytes::<32>());
    calldata.extend_from_slice(&U256::from(complexity).to_be_bytes::<32>());

    Bytes::from(calldata)
}

/// Helper function to execute a single benchmark iteration
fn execute_batch_transfer(
    spec: MegaSpecId,
    db: MemoryDatabase,
    contract_addr: Address,
    calldata: &Bytes,
) {
    let mut context =
        MegaContext::new(black_box(db), black_box(spec), DefaultExternalEnvs::default());
    context.modify_chain(|chain| {
        chain.operator_fee_scalar = Some(U256::from(0));
        chain.operator_fee_constant = Some(U256::from(0));
    });
    let mut evm = MegaEvm::new(context);

    let tx =
        TxEnvBuilder::new().caller(CALLER).call(contract_addr).data(calldata.clone()).build_fill();
    let mut mega_tx = MegaTransaction::new(tx);
    mega_tx.enveloped_tx = Some(Bytes::new());

    let result = evm.transact(mega_tx).expect("transaction should succeed");
    assert!(result.result.is_success());
    black_box(result);
}

/// Benchmark batchTransfer with different contention patterns
fn bench_ctt_batch_transfer(c: &mut Criterion) {
    // Deploy CTT once per spec to get the initial state
    let (ctt_addr_eq, initial_db_eq) = deploy_ctt(MegaSpecId::EQUIVALENCE);
    let (ctt_addr_mr, initial_db_mr) = deploy_ctt(MegaSpecId::MINI_REX);

    // Test cases: (name, numSenders, numReceivers, complexity)
    let test_cases = [
        ("low_contention_1x1", 1, 1, 0),
        ("medium_contention_5x5", 5, 5, 0),
        ("high_contention_10x10", 10, 10, 0),
        ("little_complexity_1x1", 1, 1, 5),
        ("medium_complexity_1x1", 1, 1, 50),
        ("high_complexity_1x1", 1, 1, 100),
        ("some_complexity_5x5", 5, 5, 25),
    ];

    for (test_name, num_senders, num_receivers, complexity) in test_cases {
        let mut group = c.benchmark_group(format!("batch_transfer_{}", test_name));
        let calldata = encode_batch_transfer_call(num_senders, num_receivers, 0, complexity);

        group.bench_function("equivalence", |b| {
            b.iter(|| {
                execute_batch_transfer(
                    MegaSpecId::EQUIVALENCE,
                    initial_db_eq.clone(),
                    ctt_addr_eq,
                    &calldata,
                )
            })
        });

        group.bench_function("mini_rex", |b| {
            b.iter(|| {
                execute_batch_transfer(
                    MegaSpecId::MINI_REX,
                    initial_db_mr.clone(),
                    ctt_addr_mr,
                    &calldata,
                )
            })
        });

        group.finish();
    }
}

criterion_group!(benches, bench_ctt_batch_transfer);
criterion_main!(benches);
